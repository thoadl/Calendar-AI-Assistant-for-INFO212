<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Calendar Assistant - Prototype</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Additional styles for chat interface */
    .chat-container {
      background: var(--card);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 6px 18px var(--shadow);
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      height: 400px;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .chat-mode-toggle {
      display: flex;
      gap: 8px;
    }

    .chat-mode-toggle button {
      padding: 6px 12px;
      font-size: 13px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
      padding: 8px;
      background: var(--task-bg);
      border-radius: 8px;
    }

    .chat-message {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 8px;
      max-width: 85%;
    }

    .chat-message.user {
      background: var(--accent);
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .chat-message.assistant {
      background: var(--card);
      border: 1px solid var(--border);
      margin-right: auto;
    }

    .chat-message.assistant pre {
      background: var(--task-bg);
      padding: 8px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      margin: 8px 0;
    }

    .chat-input-area {
      display: flex;
      gap: 8px;
    }

    .chat-input-area input {
      flex: 1;
    }

    .delta-preview {
      background: var(--task-bg);
      padding: 10px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 13px;
    }

    .delta-preview strong {
      color: var(--accent);
    }

    .apply-delta-btn {
      margin-top: 8px;
      width: 100%;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .typing-indicator {
      display: none;
      padding: 10px;
      color: var(--muted);
      font-style: italic;
    }

    .typing-indicator.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="dot"></div>
        <div>
          <strong>AI Calendar Assistant</strong><br><small style="color:var(--muted)">Prototype ‚Äì simple version</small>
        </div>
      </div>
      <div class="controls">
        <div style="color:var(--muted);font-size:14px" id="headerDateRange">Week: Sep 7-13, 2025</div>
        <button class="theme-toggle" onclick="toggleTheme()">
          <span class="theme-icon">üåô</span>
          <span>Dark Mode</span>
        </button>
        <button class="btn ghost" onclick="syncGoogleCalendar()">üîÑ Sync Calendar</button>
        <button class="btn ghost">Profile</button>
        <button class="btn">Connect calendar</button>
      </div>
    </header>

    <div class="main">
      <section class="calendar-card">
        <div class="calendar-header">
          <div>
            <strong id="currentViewTitle">Weekly View</strong>
            <div style="font-size:13px;color:var(--muted)">Drag tasks from the right to the desired day</div>
          </div>
          <div class="view-toggle">
            <button class="btn ghost" onclick="toggleView('day')">Day</button>
            <button class="btn active" onclick="toggleView('week')">Week</button>
            <button class="btn ghost" onclick="toggleView('month')">Month</button>
          </div>
        </div>

        <div class="calendar-navigation">
          <button class="nav-btn" onclick="navigatePeriod('prev')">‚Üê</button>
          <div class="current-period" id="currentPeriod">Sep 7-13, 2025</div>
          <button class="nav-btn" onclick="navigatePeriod('next')">‚Üí</button>
          <button class="btn ghost" onclick="goToToday()">Today</button>
        </div>

        <div class="week-grid view-week" id="weekGrid">
          <div class="day" data-date="2025-09-07"><h4>Monday</h4></div>
          <div class="day" data-date="2025-09-08"><h4>Tuesday</h4></div>
          <div class="day" data-date="2025-09-09"><h4>Wednesday</h4></div>
          <div class="day" data-date="2025-09-10"><h4>Thursday</h4></div>
          <div class="day" data-date="2025-09-11"><h4>Friday</h4></div>
          <div class="day" data-date="2025-09-12"><h4>Saturday</h4></div>
          <div class="day" data-date="2025-09-13"><h4>Sunday</h4></div>
        </div>
      </section>

      <aside>
        <!-- NEW: AI Chat Interface -->
        <div class="chat-container">
          <div class="chat-header">
            <h3 style="margin:0">AI Assistant</h3>
            <div class="chat-mode-toggle">
              <button class="btn active" id="naturalModeBtn" onclick="setChatMode('natural')">Chat</button>
              <button class="btn ghost" id="jsonModeBtn" onclick="setChatMode('json')">Actions</button>
            </div>
          </div>
          
          <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
              <strong>AI Assistant</strong>
              <p>Hello! I can help you with your calendar. Switch to <strong>Actions</strong> mode to make changes, or stay in <strong>Chat</strong> mode to ask questions.</p>
            </div>
          </div>
          
          <div class="typing-indicator" id="typingIndicator">AI is thinking...</div>
          
          <div class="chat-input-area">
            <input 
              type="text" 
              id="chatInput" 
              placeholder="Ask about your calendar or request changes..."
              onkeypress="handleChatKeypress(event)"
            />
            <button class="btn" onclick="sendChatMessage()">Send</button>
          </div>
        </div>

        <div class="actions">
          <button id="commitBtn" class="btn">Apply changes</button>
          <button id="discardBtn" class="btn ghost">Discard changes</button>
        </div>

        <div class="tasks">
          <h3>Pending Tasks</h3>
          <div class="task-list" id="taskList"></div>
          <div class="add-form">
            <input id="taskTitle" placeholder="Task name" />
            <select id="taskType">
              <option value="study">Study</option>
              <option value="work">Work</option>
              <option value="personal">Personal</option>
            </select>
            <button class="btn" onclick="testAddEvent()">Add example event</button>
          </div>
        </div>

        <div class="add-event-form">
          <h3>Add Event</h3>
          <input type="date" id="eventDate" />
          <input type="time" id="eventTime" />
          <input type="number" id="eventDuration" placeholder="Duration (minutes)" />
          <input type="text" id="eventTitle" placeholder="Event title" />
          <button id="addEventBtn" class="btn">+ Add Event</button>
        </div>
      </aside>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
  <script>
    // ==================== CHAT FUNCTIONALITY ====================
    let currentChatMode = 'natural'; // 'natural' or 'json'
    let lastDeltaResponse = null;

    function setChatMode(mode) {
      currentChatMode = mode;
      
      // Update button styles
      document.getElementById('naturalModeBtn').classList.toggle('active', mode === 'natural');
      document.getElementById('naturalModeBtn').classList.toggle('ghost', mode !== 'natural');
      document.getElementById('jsonModeBtn').classList.toggle('active', mode === 'json');
      document.getElementById('jsonModeBtn').classList.toggle('ghost', mode !== 'json');
      
      // Update placeholder
      const input = document.getElementById('chatInput');
      if (mode === 'natural') {
        input.placeholder = "Ask about your calendar...";
      } else {
        input.placeholder = "Request calendar changes (e.g., 'Add lunch tomorrow at noon')";
      }
    }

    function handleChatKeypress(event) {
      if (event.key === 'Enter') {
        sendChatMessage();
      }
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message to chat
      addChatMessage('user', message);
      input.value = '';
      
      // Show typing indicator
      const typingIndicator = document.getElementById('typingIndicator');
      typingIndicator.classList.add('active');
      
      try {
        const response = await fetch('http://localhost:8000/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            mode: currentChatMode
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          addChatMessage('assistant', `Error: ${data.error}`);
        } else if (data.type === 'natural') {
          addChatMessage('assistant', data.response);
        } else if (data.type === 'json') {
          lastDeltaResponse = data.response;
          displayJsonResponse(data);
        }
        
      } catch (error) {
        addChatMessage('assistant', `Error: ${error.message}`);
      } finally {
        typingIndicator.classList.remove('active');
      }
    }

    function addChatMessage(sender, content) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}`;
      
      if (sender === 'user') {
        messageDiv.innerHTML = `<p>${escapeHtml(content)}</p>`;
      } else {
        messageDiv.innerHTML = `<strong>AI Assistant</strong><p>${escapeHtml(content)}</p>`;
      }
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function displayJsonResponse(data) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message assistant';
      
      const preview = data.preview;
      let previewHtml = `
        <strong>AI Assistant</strong>
        <p>I've prepared the following changes:</p>
        <div class="delta-preview">
          <strong>Add:</strong> ${preview.add_count} event(s)<br>
          <strong>Update:</strong> ${preview.update_count} event(s)<br>
          <strong>Delete:</strong> ${preview.delete_count} event(s)
        </div>
      `;
      
      // Show details
      if (data.response.add && data.response.add.length > 0) {
        previewHtml += '<p><strong>Events to add:</strong></p><ul>';
        data.response.add.forEach(ev => {
          previewHtml += `<li>${escapeHtml(ev.summary || 'Untitled')}</li>`;
        });
        previewHtml += '</ul>';
      }
      
      if (data.response.update && data.response.update.length > 0) {
        previewHtml += '<p><strong>Events to update:</strong></p><ul>';
        data.response.update.forEach(ev => {
          previewHtml += `<li>${escapeHtml(ev.summary || 'Untitled')}</li>`;
        });
        previewHtml += '</ul>';
      }
      
      if (data.response.delete && data.response.delete.length > 0) {
        previewHtml += '<p><strong>Events to delete:</strong></p><ul>';
        data.response.delete.forEach(id => {
          previewHtml += `<li>Event ID: ${escapeHtml(id)}</li>`;
        });
        previewHtml += '</ul>';
      }
      
      previewHtml += '<button class="btn apply-delta-btn" onclick="applyAIDelta()">Apply These Changes</button>';
      
      messageDiv.innerHTML = previewHtml;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function applyAIDelta() {
      if (!lastDeltaResponse) {
        alert('No changes to apply');
        return;
      }
      
      try {
        const response = await fetch('http://localhost:8000/ai/apply-delta', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.error) {
          alert(`Error: ${data.error}`);
        } else {
          addChatMessage('assistant', 'Changes applied successfully! Refreshing calendar...');
          await loadEvents();
          lastDeltaResponse = null;
        }
      } catch (error) {
        alert(`Error applying changes: ${error.message}`);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==================== THEME TOGGLE ====================
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const themeToggle = document.querySelector('.theme-toggle');
      const themeIcon = themeToggle.querySelector('.theme-icon');
      const themeText = themeToggle.querySelector('span:last-child');
      
      if (currentTheme === 'dark') {
        html.removeAttribute('data-theme');
        themeIcon.textContent = 'üåô';
        themeText.textContent = 'Dark Mode';
        localStorage.setItem('theme', 'light');
      } else {
        html.setAttribute('data-theme', 'dark');
        themeIcon.textContent = '‚òÄÔ∏è';
        themeText.textContent = 'Light Mode';
        localStorage.setItem('theme', 'dark');
      }
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      const html = document.documentElement;
      const themeToggle = document.querySelector('.theme-toggle');
      const themeIcon = themeToggle.querySelector('.theme-icon');
      const themeText = themeToggle.querySelector('span:last-child');
      
      if (savedTheme === 'dark') {
        html.setAttribute('data-theme', 'dark');
        themeIcon.textContent = '‚òÄÔ∏è';
        themeText.textContent = 'Light Mode';
      } else {
        html.removeAttribute('data-theme');
        themeIcon.textContent = 'üåô';
        themeText.textContent = 'Dark Mode';
      }
    }

    // ==================== CALENDAR FUNCTIONALITY ====================
    let originalWeekHTML = null;
    let loadedEvents = [];
    let currentView = 'week';
    let currentDate = new Date();

    document.addEventListener('DOMContentLoaded', () => {
      const grid = document.getElementById("weekGrid");
      originalWeekHTML = grid.innerHTML;
      initDragAndDrop();
      loadEvents();
      updateCurrentPeriodDisplay();
      loadTheme();
    });

    function navigatePeriod(direction) {
      if (currentView === 'day') {
        currentDate.setDate(currentDate.getDate() + (direction === 'next' ? 1 : -1));
      } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + (direction === 'next' ? 7 : -7));
      } else if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + (direction === 'next' ? 1 : -1));
      }
      
      updateCalendarView();
      updateCurrentPeriodDisplay();
    }

    function goToToday() {
      currentDate = new Date();
      updateCalendarView();
      updateCurrentPeriodDisplay();
    }

    function updateCalendarView() {
      if (currentView === 'month') {
        generateMonthView(currentDate.getFullYear(), currentDate.getMonth());
      } else if (currentView === 'week') {
        generateWeekView(currentDate);
      } else if (currentView === 'day') {
        generateDayView(currentDate);
      }
      paintEvents();
    }

    function updateCurrentPeriodDisplay() {
      const periodElement = document.getElementById('currentPeriod');
      const headerElement = document.getElementById('headerDateRange');
      
      if (currentView === 'day') {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateString = currentDate.toLocaleDateString('en-US', options);
        periodElement.textContent = dateString;
        headerElement.textContent = `Day: ${dateString}`;
      } else if (currentView === 'week') {
        const weekRange = getWeekRange(currentDate);
        periodElement.textContent = `${weekRange.start} - ${weekRange.end}`;
        headerElement.textContent = `Week: ${weekRange.start} - ${weekRange.end}`;
      } else if (currentView === 'month') {
        const monthName = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        periodElement.textContent = monthName;
        headerElement.textContent = `Month: ${monthName}`;
      }
      
      document.getElementById('currentViewTitle').textContent = 
        `${currentView === 'day' ? 'Daily' : currentView === 'week' ? 'Weekly' : 'Monthly'} View`;
    }

    function getWeekRange(date) {
      const startOfWeek = new Date(date);
      const dayOfWeek = startOfWeek.getDay();
      const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      startOfWeek.setDate(date.getDate() + diffToMonday);
      
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      
      const formatDate = (d) => {
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };
      
      return {
        start: formatDate(startOfWeek),
        end: formatDate(endOfWeek) + ', ' + endOfWeek.getFullYear()
      };
    }

    function generateMonthView(year, month) {
      const grid = document.getElementById("weekGrid");
      grid.innerHTML = "";

      const firstDay = new Date(year, month, 1);
      const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;

      for (let i = 0; i < totalCells; i++) {
        const dayEl = document.createElement("div");
        dayEl.classList.add("day");
        const dayNum = i - startDay + 1;
        if (dayNum > 0 && dayNum <= daysInMonth) {
          const date = new Date(year, month, dayNum);
          const dateStr = date.toISOString().slice(0, 10);
          dayEl.dataset.date = dateStr;
          const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
          dayEl.innerHTML = `<h4>${dayNum} ${dayName}</h4>`;
        } else {
          dayEl.innerHTML = `<h4></h4>`;
        }
        grid.appendChild(dayEl);
      }
      initDragAndDrop();
    }

    function generateWeekView(startDate) {
      const grid = document.getElementById("weekGrid");
      grid.innerHTML = '';
      
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const date = new Date(startDate);
      
      const dayOfWeek = date.getDay();
      const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      date.setDate(date.getDate() + diffToMonday);
      
      for (let i = 0; i < 7; i++) {
        const dayEl = document.createElement("div");
        dayEl.classList.add("day");
        
        const currentDate = new Date(date);
        currentDate.setDate(date.getDate() + i);
        const dateStr = currentDate.toISOString().slice(0, 10);
        
        dayEl.dataset.date = dateStr;
        dayEl.innerHTML = `<h4>${days[i]}<br><small>${currentDate.getMonth()+1}/${currentDate.getDate()}</small></h4>`;
        
        grid.appendChild(dayEl);
      }
      initDragAndDrop();
    }

    function generateDayView(date) {
      const grid = document.getElementById("weekGrid");
      grid.innerHTML = '';
      
      const dayEl = document.createElement("div");
      dayEl.classList.add("day");
      
      const dateStr = date.toISOString().slice(0, 10);
      const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
      const dateFormatted = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      
      dayEl.dataset.date = dateStr;
      dayEl.innerHTML = `<h4>${dayName}<br><small>${dateFormatted}</small></h4>`;
      
      grid.appendChild(dayEl);
      initDragAndDrop();
    }

    window.toggleView = function(view) {
      const grid = document.getElementById('weekGrid');
      if (!grid || currentView === view) return;

      grid.classList.remove('view-day','view-week','view-month');
      grid.classList.add(`view-${view}`);
      
      document.querySelectorAll('.view-toggle .btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.view-toggle .btn').forEach(btn => {
        if (btn.textContent.toLowerCase() === view) {
          btn.classList.add('active');
        }
      });

      currentView = view;
      updateCalendarView();
      updateCurrentPeriodDisplay();
    };

    function initDragAndDrop() {
      let draggedSlot = null;

      document.querySelectorAll('.slot').forEach(slot => {
        slot.setAttribute('draggable', 'true');
        slot.addEventListener('dragstart', e => {
          draggedSlot = slot;
          slot.classList.add('dragging');
        });
        slot.addEventListener('dragend', () => {
          slot.classList.remove('dragging');
          draggedSlot = null;
        });
      });

      document.querySelectorAll('.day').forEach(day => {
        day.addEventListener('dragover', e => {
          e.preventDefault();
          day.classList.add('drop-over');
        });
        day.addEventListener('dragleave', () => {
          day.classList.remove('drop-over');
        });
        day.addEventListener('drop', e => {
          e.preventDefault();
          day.classList.remove('drop-over');
          if (draggedSlot) {
            day.appendChild(draggedSlot);
            draggedSlot = null;
          }
        });
      });
    }

    async function loadEvents() {
      try {
        const res = await fetch("http://localhost:8000/events");
        loadedEvents = await res.json();
        paintEvents();
      } catch (err) {
        console.error("Error loading events:", err);
      }
    }

    function paintEvents() {
      if (!loadedEvents.length) return;

      document.querySelectorAll(".day").forEach(day =>
        day.querySelectorAll(".slot").forEach(s => s.remove())
      );

      loadedEvents.forEach(ev => {
        const start = ev.start.dateTime || ev.start.date;
        const end = ev.end.dateTime || ev.end.date;
        const dateStr = start.slice(0,10);
        const dayEl = document.querySelector(`.day[data-date="${dateStr}"]`);
        if (!dayEl) return;

        const slot = document.createElement("div");
        slot.classList.add("slot");
        slot.setAttribute("draggable", "true");

        if (ev.draft) slot.classList.add("draft");
        else slot.classList.add("real");
        if (ev.conflict) slot.classList.add("conflict");

        const isMonthView = currentView === 'month';
        slot.textContent = isMonthView
          ? `‚Ä¢ ${ev.summary}`
          : `${start.substring(11,16)} - ${end.substring(11,16)} ‚Ä¢ ${ev.summary}`;

        dayEl.appendChild(slot);
      });

      initDragAndDrop();
    }

    window.testAddEvent = async function() {
      const newEvent = {
        date: currentDate.toISOString().slice(0,10),
        time: "17:00",
        duration: 90,
        title: "Example event"
      };
      await addEventToDraft(newEvent);
    }

    async function addEventToDraft(ev) {
      await fetch("http://localhost:8000/draft/add", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(ev)
      });
      loadEvents();
    }

    document.getElementById("commitBtn").addEventListener("click", async () => {
      await fetch("http://localhost:8000/commit", { method: "POST" });
      alert("Changes applied successfully");
      loadEvents();
    });

    document.getElementById("discardBtn").addEventListener("click", () => {
      fetch("http://localhost:8000/discard", { method: "POST" })
        .then(r => r.json())
        .then(() => {
          alert("Changes discarded");
          loadEvents();
        });
    });

    document.getElementById("addEventBtn").addEventListener("click", async () => {
      const date = document.getElementById("eventDate").value;
      const time = document.getElementById("eventTime").value;
      const duration = parseInt(document.getElementById("eventDuration").value);
      const title = document.getElementById("eventTitle").value;

      if (!date || !time || !duration || !title) {
        alert("Please complete all fields");
        return;
      }

      const start = `${date}T${time}:00`;
      const endDate = new Date(start);
      endDate.setMinutes(endDate.getMinutes() + duration);
      
      const pad = n => n.toString().padStart(2, "0");
      const end = `${endDate.getFullYear()}-${pad(endDate.getMonth()+1)}-${pad(endDate.getDate())}T${pad(endDate.getHours())}:${pad(endDate.getMinutes())}:00`;
      const newEvent = { start, end, title, draft: true };

      await fetch("http://localhost:8000/draft/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newEvent)
      });

      loadEvents();

      document.getElementById("eventDate").value = "";
      document.getElementById("eventTime").value = "";
      document.getElementById("eventDuration").value = "";
      document.getElementById("eventTitle").value = "";
    });
  </script>
</body>
</html>
